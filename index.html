<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商场品牌招聘信息</title>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        /* 基础样式 */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { background-color: #f5f7fa; color: #333; padding-bottom: 2rem; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
        
        /* 头部 */
        header { background-color: #2c3e50; color: white; padding: 1rem 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .site-title { font-size: 1.8rem; text-align: center; cursor: pointer; margin-bottom: 0.5rem; }
        .site-subtitle { font-size: 0.9rem; text-align: center; opacity: 0.8; }
        
        /* 状态条 */
        .status-bar { background: white; border-radius: 8px; padding: 1rem; margin: 1.5rem 0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; justify-content: space-between; }
        .stats { color: #666; }
        .stats strong { color: #2c3e50; }
        .update-time { color: #7f8c8d; font-size: 0.9rem; }
        
        /* 维护中状态 */
        .maintenance { text-align: center; padding: 4rem 2rem; color: #7f8c8d; }
        .maintenance i { font-size: 3rem; margin-bottom: 1rem; animation: spin 2s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* 招聘卡片 */
        .job-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem; margin: 2rem 0; }
        .job-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.3s; }
        .job-card:hover { transform: translateY(-5px); }
        .card-header { background-color: #3498db; color: white; padding: 1rem; }
        .brand-name { font-size: 1.2rem; font-weight: 600; }
        .job-position { font-size: 0.95rem; opacity: 0.9; margin-top: 0.3rem; }
        .card-body { padding: 1rem; }
        .info-item { display: flex; align-items: center; margin-bottom: 0.5rem; font-size: 0.9rem; }
        .info-item i { color: #3498db; width: 20px; margin-right: 0.5rem; }
        .section-title { font-size: 0.9rem; font-weight: 600; margin: 1rem 0 0.5rem; color: #2c3e50; padding-bottom: 0.3rem; border-bottom: 1px solid #eee; }
        .requirements { font-size: 0.9rem; padding-left: 1.5rem; }
        
        /* 分页 */
        .pagination { display: flex; justify-content: center; gap: 0.5rem; margin: 2rem 0; }
        .page-btn { padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; }
        .page-btn:hover { background-color: #3498db; color: white; border-color: #3498db; }
        .page-btn.active { background-color: #3498db; color: white; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* 管理员弹窗 */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 8px; width: 90%; max-width: 500px; padding: 1.5rem; }
        .modal-title { font-size: 1.2rem; margin-bottom: 1rem; color: #2c3e50; }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-control { width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 4px; }
        .btn { width: 100%; padding: 0.7rem; border: none; border-radius: 4px; font-weight: 500; cursor: pointer; }
        .btn-primary { background: #3498db; color: white; }
        .btn-secondary { background: #ecf0f1; margin-top: 0.5rem; }
        .upload-area { border: 2px dashed #bdc3c7; padding: 2rem; text-align: center; margin: 1rem 0; cursor: pointer; }
        .upload-icon { font-size: 2rem; color: #7f8c8d; margin-bottom: 0.5rem; }
        .upload-input { display: none; }
        .status-message { padding: 0.7rem; border-radius: 4px; margin: 1rem 0; display: none; }
        .status-success { background: #d5f5e3; color: #27ae60; display: block; }
        .status-error { background: #fadbd8; color: #e74c3c; display: block; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <!-- 头部标题（管理员连续点击5次进入） -->
    <header>
        <div class="container">
            <h1 id="siteTitle" class="site-title">商场品牌招聘信息</h1>
            <p class="site-subtitle">官方发布 · 多设备同步</p>
        </div>
    </header>

    <!-- 管理员弹窗 -->
    <div id="adminModal" class="modal-overlay">
        <div class="modal">
            <h2 class="modal-title">管理员操作</h2>
            
            <!-- 密码验证 -->
            <div id="passwordSection">
                <div class="form-group">
                    <label class="form-label">管理员密码</label>
                    <input type="password" id="adminPassword" class="form-control" placeholder="输入密码">
                </div>
                <button id="verifyBtn" class="btn btn-primary">验证</button>
            </div>
            
            <!-- 文件上传（验证后显示） -->
            <div id="uploadSection" class="hidden">
                <label class="upload-area" for="fileInput">
                    <input type="file" id="fileInput" class="upload-input" accept=".xlsx">
                    <div class="upload-icon"><i class="fa fa-cloud-upload"></i></div>
                    <div>点击或拖拽Excel文件到此处上传</div>
                </label>
                <div id="uploadStatus" class="status-message"></div>
                <button id="closeBtn" class="btn btn-secondary">关闭</button>
            </div>
        </div>
    </div>

    <!-- 主要内容 -->
    <main class="container">
        <!-- 状态条 -->
        <div class="status-bar">
            <div class="stats">
                <i class="fa fa-briefcase"></i> 共 <strong id="totalJobs">0</strong> 个岗位
            </div>
            <div class="update-time" id="lastUpdate">最后更新：暂无数据</div>
        </div>
        
        <!-- 内容区域 -->
        <div class="content-area">
            <!-- 维护中状态（默认显示） -->
            <div id="maintenanceView" class="maintenance">
                <i class="fa fa-cogs"></i>
                <h2>招聘信息维护中</h2>
                <p>请等待管理员上传最新信息</p>
            </div>
            
            <!-- 招聘列表（有数据时显示） -->
            <div id="jobsView" class="hidden">
                <div class="job-list" id="jobList"></div>
                <div class="pagination" id="pagination">
                    <button class="page-btn" id="prevPage" disabled>上一页</button>
                    <div id="pageNumbers"></div>
                    <button class="page-btn" id="nextPage">下一页</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // 已填入你的Supabase信息
        const SUPABASE_URL = "https://hrawzbkcjbpsgcrwvipu.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhyYXd6YmtjamJwc2djcnd2aXB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NTk4ODEsImV4cCI6MjA3MDMzNTg4MX0.mOaonwTN68DG_sGEIUWK_M9aFSUx2324Tev5kSrPaW8";
        const ADMIN_PASSWORD = "admin123"; // 管理员密码（可修改）
        
        // 初始化Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // 全局变量
        let clickCount = 0;
        let clickTimer = null;
        let currentPage = 1;
        const PAGE_SIZE = 6;
        let allJobs = [];
        
        // DOM元素
        const siteTitle = document.getElementById('siteTitle');
        const adminModal = document.getElementById('adminModal');
        const passwordSection = document.getElementById('passwordSection');
        const uploadSection = document.getElementById('uploadSection');
        const adminPassword = document.getElementById('adminPassword');
        const verifyBtn = document.getElementById('verifyBtn');
        const fileInput = document.getElementById('fileInput');
        const uploadStatus = document.getElementById('uploadStatus');
        const closeBtn = document.getElementById('closeBtn');
        const maintenanceView = document.getElementById('maintenanceView');
        const jobsView = document.getElementById('jobsView');
        const jobList = document.getElementById('jobList');
        const totalJobsEl = document.getElementById('totalJobs');
        const lastUpdateEl = document.getElementById('lastUpdate');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const pageNumbersEl = document.getElementById('pageNumbers');
        
        // 页面加载时执行
        document.addEventListener('DOMContentLoaded', () => {
            bindEvents();
            loadData(); // 从云端加载数据
        });
        
        // 绑定所有按钮事件
        function bindEvents() {
            // 标题点击（管理员入口）
            siteTitle.addEventListener('click', () => {
                clickCount++;
                clearTimeout(clickTimer);
                clickTimer = setTimeout(() => clickCount = 0, 3000); // 3秒内没再点则重置
                if (clickCount >= 5) {
                    adminModal.classList.add('active');
                    clickCount = 0;
                }
            });
            
            // 密码验证
            verifyBtn.addEventListener('click', () => {
                if (adminPassword.value === ADMIN_PASSWORD) {
                    passwordSection.classList.add('hidden');
                    uploadSection.classList.remove('hidden');
                    adminPassword.value = '';
                } else {
                    showStatus('密码错误', 'error');
                }
            });
            
            // 关闭弹窗
            closeBtn.addEventListener('click', () => {
                adminModal.classList.remove('active');
                uploadSection.classList.add('hidden');
                passwordSection.classList.remove('hidden');
                fileInput.value = '';
            });
            
            // 点击弹窗外部关闭
            adminModal.addEventListener('click', (e) => {
                if (e.target === adminModal) closeBtn.click();
            });
            
            // 文件上传
            fileInput.addEventListener('change', handleUpload);
            
            // 分页按钮
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderPage();
                }
            });
            nextPageBtn.addEventListener('click', () => {
                if (currentPage < getTotalPages()) {
                    currentPage++;
                    renderPage();
                }
            });
        }
        
        // 从云端加载数据
        async function loadData() {
            // 加载招聘信息
            const { data: jobs } = await supabase.from('jobs').select('*').order('created_at', { ascending: false });
            allJobs = jobs || [];
            
            // 加载最后更新时间
            const { data: metadata } = await supabase.from('metadata').select('last_update').single();
            if (metadata?.last_update) {
                lastUpdateEl.textContent = `最后更新：${metadata.last_update}`;
            }
            
            // 更新显示
            updateDisplay();
        }
        
        // 更新页面显示
        function updateDisplay() {
            totalJobsEl.textContent = allJobs.length;
            
            if (allJobs.length === 0) {
                maintenanceView.classList.remove('hidden');
                jobsView.classList.add('hidden');
            } else {
                maintenanceView.classList.add('hidden');
                jobsView.classList.remove('hidden');
                currentPage = 1;
                renderPage();
            }
        }
        
        // 渲染当前页数据
        function renderPage() {
            const start = (currentPage - 1) * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const pageJobs = allJobs.slice(start, end);
            
            // 清空列表
            jobList.innerHTML = '';
            
            // 添加岗位卡片
            pageJobs.forEach(job => {
                const card = document.createElement('div');
                card.className = 'job-card';
                card.innerHTML = `
                    <div class="card-header">
                        <div class="brand-name">${job.brand}</div>
                        <div class="job-position">${job.position}</div>
                    </div>
                    <div class="card-body">
                        <div class="info-item"><i class="fa fa-money"></i>${job.salary}</div>
                        <div class="info-item"><i class="fa fa-map-marker"></i>${job.location}</div>
                        <div class="info-item"><i class="fa fa-user"></i>${job.contactPerson}</div>
                        <div class="info-item"><i class="fa fa-phone"></i>${job.contactPhone}</div>
                        <div class="info-item"><i class="fa fa-calendar"></i>有效期至：${job.expiryDate}</div>
                        
                        <div class="section-title">岗位职责</div>
                        <ul class="requirements">${formatList(job.responsibilities)}</ul>
                        
                        <div class="section-title">岗位要求</div>
                        <ul class="requirements">${formatList(job.requirements)}</ul>
                    </div>
                `;
                jobList.appendChild(card);
            });
            
            // 更新分页按钮
            updatePagination();
        }
        
        // 格式化列表
        function formatList(text) {
            return text.split(/[；;]/).filter(item => item).map(item => `<li>${item}</li>`).join('') || '<li>无</li>';
        }
        
        // 获取总页数
        function getTotalPages() {
            return Math.ceil(allJobs.length / PAGE_SIZE);
        }
        
        // 更新分页按钮
        function updatePagination() {
            const totalPages = getTotalPages();
            pageNumbersEl.innerHTML = '';
            
            // 添加页码按钮
            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                btn.textContent = i;
                btn.addEventListener('click', () => {
                    currentPage = i;
                    renderPage();
                });
                pageNumbersEl.appendChild(btn);
            }
            
            // 禁用/启用上一页/下一页
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
        }
        
        // 处理文件上传
        async function handleUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.xlsx')) {
                showStatus('请上传XLSX格式的Excel文件', 'error');
                return;
            }
            
            showStatus('正在解析文件...', 'info');
            
            try {
                // 解析Excel
                const data = await readExcel(file);
                if (data.length === 0) {
                    showStatus('未找到有效数据（请确保有"通过"状态的记录）', 'error');
                    return;
                }
                
                // 先删除旧数据
                await supabase.from('jobs').delete().neq('id', '');
                
                // 上传新数据
                await supabase.from('jobs').insert(data);
                
                // 更新最后更新时间
                const now = new Date().toLocaleString('zh-CN');
                await supabase.from('metadata').update({ last_update: now }).eq('id', 1);
                
                // 重新加载数据
                allJobs = data;
                updateDisplay();
                showStatus('上传成功！所有设备已同步更新', 'success');
                
                // 3秒后关闭弹窗
                setTimeout(() => closeBtn.click(), 3000);
                
            } catch (error) {
                console.error(error);
                showStatus('上传失败，请重试', 'error');
            }
        }
        
        // 读取Excel文件
        function readExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                        
                        // 解析数据（只保留审核状态为"通过"的行）
                        const jobs = [];
                        for (let i = 1; i < json.length; i++) { // 从第2行开始（跳过表头）
                            const row = json[i];
                            if (row[9] === '通过') { // 第10列（索引9）是审核状态
                                jobs.push({
                                    brand: row[0] || '',
                                    position: row[1] || '',
                                    responsibilities: row[2] || '',
                                    requirements: row[3] || '',
                                    salary: row[4] || '',
                                    location: row[5] || '',
                                    contactPerson: row[6] || '',
                                    contactPhone: row[7] || '',
                                    expiryDate: row[8] || ''
                                });
                            }
                        }
                        resolve(jobs);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }
        
        // 显示状态信息
        function showStatus(message, type) {
            uploadStatus.textContent = message;
            uploadStatus.className = `status-message status-${type}`;
        }
    </script>
</body>
</html>