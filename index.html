<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>商场品牌招聘信息</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#64748b',
                        neutral: '#f1f5f9',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .job-card {
                @apply bg-white rounded-lg shadow-sm overflow-hidden mb-4 border border-gray-100 transition-all duration-200 hover:shadow-md;
            }
            .card-header {
                @apply bg-primary/5 px-5 py-3 border-b border-gray-100;
            }
            .info-group {
                @apply grid grid-cols-2 gap-x-4 gap-y-3;
            }
            .info-item {
                @apply flex items-center;
            }
            .info-icon {
                @apply w-4 text-primary mr-2 flex-shrink-0;
            }
            .info-text {
                @apply text-sm;
            }
            .section-title {
                @apply text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2;
            }
            .pagination-btn {
                @apply px-3 py-1.5 rounded border border-gray-200 bg-white text-gray-700 text-sm hover:bg-primary hover:text-white hover:border-primary transition-colors;
            }
            .pagination-btn.active {
                @apply bg-primary text-white border-primary;
            }
            .pagination-btn:disabled {
                @apply opacity-50 cursor-not-allowed hover:bg-white hover:text-gray-700 hover:border-gray-200;
            }
            .loading {
                @apply text-center py-10 text-gray-500;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">
    <!-- 顶部导航 -->
    <header class="bg-primary text-white shadow-md sticky top-0 z-10">
        <div class="container mx-auto px-5 py-4">
            <h1 class="text-xl font-bold text-center">商场品牌招聘信息</h1>
            <p class="text-center text-blue-100 text-xs mt-1">
                实时更新 · 官方发布
            </p>
        </div>
    </header>

    <!-- 主要内容区 -->
    <main class="container mx-auto px-4 py-5">
        <!-- 统计信息条 -->
        <div class="bg-white rounded-lg shadow-sm p-3 mb-5 border border-gray-100">
            <div class="flex justify-between items-center">
                <div class="text-sm text-gray-600">
                    <i class="fa fa-briefcase text-primary mr-1"></i>
                    共 <span id="total-jobs" class="font-medium text-primary">0</span> 个有效岗位
                </div>
                <div class="text-sm text-gray-500" id="update-time"></div>
            </div>
        </div>

        <!-- 招聘信息容器 -->
        <div id="jobs-container">
            <!-- 加载状态 -->
            <div class="loading">
                <i class="fa fa-spinner fa-spin mr-2"></i> 正在加载招聘信息...
            </div>
        </div>

        <!-- 分页控件 -->
        <div class="flex justify-center items-center mt-6 mb-4 gap-1 flex-wrap" id="pagination" style="display: none;">
            <button id="prev-page" class="pagination-btn" disabled>
                <i class="fa fa-angle-left"></i> 上一页
            </button>
            <div id="page-numbers" class="flex gap-1"></div>
            <button id="next-page" class="pagination-btn">
                下一页 <i class="fa fa-angle-right"></i>
            </button>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white border-t border-gray-200 py-4 mt-8">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-500 text-xs">© 2023 商场管理中心 | 本招聘信息由各品牌商铺提供</p>
        </div>
    </footer>

    <script>
        // 分页配置
        const PAGE_SIZE = 8;
        let currentPage = 1;
        let totalPages = 1;
        let jobsData = [];

        // DOM元素
        const jobsContainer = document.getElementById('jobs-container');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const pageNumbersContainer = document.getElementById('page-numbers');
        const totalJobsEl = document.getElementById('total-jobs');
        const updateTimeEl = document.getElementById('update-time');
        const paginationContainer = document.getElementById('pagination');

        // 金山文档配置（从你的链接提取）
        const KINGSOFT_DOC_ID = 'cr2LsMcCyWXc';  // 从链接https://kdocs.cn/l/cr2LsMcCyWXc提取
        const KINGSOFT_SHEET_ID = 'sheet0';      // 默认第一个工作表

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            fetchKingsoftDocData();
        });

        // 从金山文档获取数据（使用双重代理保障稳定性）
        async function fetchKingsoftDocData() {
            try {
                // 1. 金山文档API地址（获取A1到J2000范围的数据）
                const kingsoftApi = `https://www.kdocs.cn/api/v3/office/file/${KINGSOFT_DOC_ID}/sheet/${KINGSOFT_SHEET_ID}/cells?range=A1:J2000`;
                
                // 2. 使用稳定代理（双重代理备选，确保跨域可用）
                const proxies = [
                    `https://api.allorigins.win/get?url=${encodeURIComponent(kingsoftApi)}`,
                    `https://cors.bridged.cc/${kingsoftApi}`
                ];
                
                // 尝试第一个代理，失败则自动切换到第二个
                let response, proxyResponse, data;
                for (const proxyUrl of proxies) {
                    try {
                        response = await fetch(proxyUrl);
                        if (response.ok) {
                            // 不同代理返回格式不同，统一处理
                            if (proxyUrl.includes('allorigins')) {
                                proxyResponse = await response.json();
                                data = JSON.parse(proxyResponse.contents);
                            } else {
                                data = await response.json();
                            }
                            break; // 成功获取数据，退出循环
                        }
                    } catch (e) {
                        console.log(`代理 ${proxyUrl} 失败，尝试下一个`);
                    }
                }
                
                if (!data) {
                    throw new Error('所有代理均请求失败');
                }
                
                // 3. 转换数据格式
                jobsData = parseKingsoftDocData(data);
                
                // 4. 更新页面
                totalJobsEl.textContent = jobsData.length;
                const now = new Date();
                updateTimeEl.textContent = `更新于: ${now.toLocaleString('zh-CN')}`;
                totalPages = Math.ceil(jobsData.length / PAGE_SIZE);
                initPagination();
                displayPage(currentPage);
                paginationContainer.style.display = 'flex';
                bindPaginationEvents();
                
            } catch (error) {
                console.error('获取数据出错:', error);
                jobsContainer.innerHTML = `
                    <div class="text-center py-10 text-red-500">
                        <i class="fa fa-exclamation-circle mr-2"></i> 加载失败，请稍后重试<br>
                        <span class="text-xs mt-2 inline-block">若持续失败，请检查文档是否设置为"所有人可查看"</span>
                    </div>
                `;
            }
        }

        // 解析金山文档数据（适配其返回格式）
        function parseKingsoftDocData(rawData) {
            try {
                // 金山文档返回的单元格数据在 cells 数组中
                const cells = rawData.data?.cells || [];
                const jobs = [];
                const rowMap = {}; // 按行号分组单元格
                
                // 1. 按行号整理数据
                cells.forEach(cell => {
                    const row = cell.row; // 行号（从0开始）
                    const col = cell.col; // 列号（A=0, B=1, ..., J=9）
                    if (!rowMap[row]) rowMap[row] = [];
                    rowMap[row][col] = cell.value || ''; // 单元格值
                });
                
                // 2. 提取有效数据（跳过表头行 row=0）
                Object.keys(rowMap).forEach(row => {
                    if (parseInt(row) === 0) return; // 跳过表头
                    
                    const rowData = rowMap[row];
                    // 只保留审核状态为"通过"的岗位（J列=9）
                    if (rowData[9] === '通过') {
                        jobs.push({
                            brand: rowData[0] || '未填写',               // A列（0）
                            position: rowData[1] || '未填写',            // B列（1）
                            responsibilities: rowData[2] || '无',        // C列（2）
                            requirements: rowData[3] || '无',            // D列（3）
                            salary: rowData[4] || '未填写',              // E列（4）
                            location: rowData[5] || '未填写',            // F列（5）
                            contactPerson: rowData[6] || '未填写',       // G列（6）
                            contactPhone: rowData[7] || '未填写',        // H列（7）
                            expiryDate: rowData[8] || '未填写',          // I列（8）
                            auditStatus: rowData[9] || '未审核'          // J列（9）
                        });
                    }
                });
                
                return jobs;
            } catch (error) {
                console.error('数据解析错误:', error);
                return [];
            }
        }

        // 分页相关函数
        function initPagination() {
            pageNumbersContainer.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.dataset.page = i;
                pageNumbersContainer.appendChild(pageBtn);
            }
            updatePaginationButtons();
        }

        function bindPaginationEvents() {
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    displayPage(currentPage);
                    updatePaginationButtons();
                    scrollToTop();
                }
            });
            
            nextPageBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    displayPage(currentPage);
                    updatePaginationButtons();
                    scrollToTop();
                }
            });
            
            pageNumbersContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && e.target.dataset.page) {
                    const page = parseInt(e.target.dataset.page);
                    if (page !== currentPage) {
                        currentPage = page;
                        displayPage(currentPage);
                        updatePaginationButtons();
                        scrollToTop();
                    }
                }
            });
        }

        function updatePaginationButtons() {
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
            document.querySelectorAll('#page-numbers button').forEach(btn => {
                const page = parseInt(btn.dataset.page);
                btn.classList.toggle('active', page === currentPage);
            });
        }

        function displayPage(page) {
            jobsContainer.innerHTML = '';
            
            if (jobsData.length === 0) {
                jobsContainer.innerHTML = `
                    <div class="text-center py-10 text-gray-500">
                        <i class="fa fa-info-circle mr-2"></i> 暂无有效招聘信息
                    </div>
                `;
                return;
            }
            
            const startIndex = (page - 1) * PAGE_SIZE;
            const endIndex = Math.min(startIndex + PAGE_SIZE, jobsData.length);
            const currentPageData = jobsData.slice(startIndex, endIndex);
            
            currentPageData.forEach(job => {
                const jobElement = createJobElement(job);
                jobsContainer.appendChild(jobElement);
            });
        }

        function createJobElement(job) {
            const jobDiv = document.createElement('div');
            jobDiv.className = 'job-card';

            const responsibilitiesList = job.responsibilities
                .split(/[；;]/)
                .filter(item => item.trim() !== '')
                .map(item => `<li class="text-sm text-gray-700 mb-1">${item}</li>`)
                .join('');

            const requirementsList = job.requirements
                .split(/[；;]/)
                .filter(item => item.trim() !== '')
                .map(item => `<li class="text-sm text-gray-700 mb-1">${item}</li>`)
                .join('');

            jobDiv.innerHTML = `
                <div class="card-header">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-primary font-bold">${job.brand}</h3>
                            <p class="text-gray-800 mt-0.5">${job.position}</p>
                        </div>
                        <span class="bg-green-100 text-green-800 text-xs px-2 py-0.5 rounded-full">
                            正在招聘
                        </span>
                    </div>
                </div>
                
                <div class="px-5 py-4">
                    <div class="info-group mb-4">
                        <div class="info-item">
                            <i class="fa fa-money info-icon"></i>
                            <span class="info-text font-medium">${job.salary}</span>
                        </div>
                        <div class="info-item">
                            <i class="fa fa-map-marker info-icon"></i>
                            <span class="info-text">${job.location}</span>
                        </div>
                        <div class="info-item">
                            <i class="fa fa-user info-icon"></i>
                            <span class="info-text">${job.contactPerson}</span>
                        </div>
                        <div class="info-item">
                            <i class="fa fa-phone info-icon"></i>
                            <span class="info-text">${job.contactPhone}</span>
                        </div>
                        <div class="info-item col-span-2">
                            <i class="fa fa-calendar info-icon"></i>
                            <span class="info-text">有效期至: ${job.expiryDate}</span>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h4 class="section-title">岗位职责</h4>
                        <ul class="list-disc pl-5">${responsibilitiesList || '<li class="text-sm text-gray-500">暂无信息</li>'}</ul>
                    </div>
                    
                    <div>
                        <h4 class="section-title">岗位要求</h4>
                        <ul class="list-disc pl-5">${requirementsList || '<li class="text-sm text-gray-500">暂无信息</li>'}</ul>
                    </div>
                </div>
            `;

            return jobDiv;
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>
